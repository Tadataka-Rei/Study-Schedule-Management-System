<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - SSMS</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .section-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .schedule-item {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px inset #eee;
        }

        .btn-remove {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Create Course</h1>
            <div class="user-info">
                <span>Welcome, <span id="userName"></span></span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </header>

        <main class="dashboard-content">
            <section class="form-section">
                <div class="section-header">
                    <h2>Create New Course</h2>
                    <button onclick="window.location.href='/admin/courses'" class="btn-cancel">Back</button>
                </div>

                <form id="createCourseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Course Code *</label>
                            <input type="text" id="code" required placeholder="e.g., CS101">
                        </div>
                        <div class="form-group">
                            <label>Course Name *</label>
                            <input type="text" id="name" required placeholder="e.g., Intro to CS">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Credits *</label>
                            <input type="number" id="credits" required min="1" max="10" value="3">
                        </div>
                        <div class="form-group">
                            <label>Main Lecturer *</label>
                            <select id="ownerLecturerId" required>
                                <option value="">Select Lecturer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Semester *</label>
                            <select id="semesterId" required>
                                <option value="">Select Semester</option>
                            </select>
                        </div>
                    </div>

                    <div class="sections-section">
                        <h3>Course Sections</h3>
                        <div id="sectionsContainer">
                        </div>
                        <button type="button" onclick="addSection()" class="btn-secondary">+ Add Another
                            Section</button>
                    </div>

                    <div class="form-actions" style="margin-top: 30px;">
                        <button type="submit" class="btn-primary">Create Course</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        let lecturers = [], semesters = [], rooms = [];

        document.addEventListener('DOMContentLoaded', async () => {
            loadUserInfo();
            await loadFormData();
            addSection(); // Add the first section automatically
        });

        async function loadFormData() {
            try {
                const response = await fetch('/admin/courses/form-data');
                const data = await response.json();
                if (data.success) {
                    lecturers = data.lecturers;
                    semesters = data.semesters;
                    rooms = data.rooms;

                    const lecSelect = document.getElementById('ownerLecturerId');
                    lecturers.forEach(l => lecSelect.add(new Option(l.profile.fullName, l._id)));

                    const semSelect = document.getElementById('semesterId');
                    semesters.forEach(s => semSelect.add(new Option(s.name, s._id)));
                }
            } catch (err) { console.error(err); }
        }

        function addSection() {
            const container = document.getElementById('sectionsContainer');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-item';
            sectionDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Section ID</label>
                        <input type="text" class="sec-id" placeholder="e.g., A01" required>
                    </div>
                    <div class="form-group">
                        <label>Section Lecturer</label>
                        <select class="sec-lecturer">
                            <option value="">Default (Main Lecturer)</option>
                            ${lecturers.map(l => `<option value="${l._id}">${l.profile.fullName}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" class="sec-cap" value="30" min="1">
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="btn-remove">Remove Section</button>
                </div>
                <div class="schedule-area">
                    <div class="schedule-list"></div>
                    <button type="button" onclick="addScheduleItem(this)" class="btn-secondary" style="font-size: 0.8em;">+ Add Class Time</button>
                </div>
            `;
            container.appendChild(sectionDiv);
        }

        function addScheduleItem(btn) {
            const list = btn.previousElementSibling;
            const div = document.createElement('div');
            div.className = 'schedule-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Day</label>
                    <select class="sch-day">
                        <option value="1">Monday</option><option value="2">Tuesday</option>
                        <option value="3">Wednesday</option><option value="4">Thursday</option>
                        <option value="5">Friday</option><option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start</label>
                    <input type="time" class="sch-start" required>
                </div>
                <div class="form-group">
                    <label>End</label>
                    <input type="time" class="sch-end" required>
                </div>
                <div class="form-group">
                    <label>Room</label>
                    <select class="sch-room" required>
                        ${rooms.map(r => `<option value="${r._id}">${r.code} (${r.building})</option>`).join('')}
                    </select>
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="btn-remove">X</button>
            `;
            list.appendChild(div);
        }

        document.getElementById('createCourseForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Structure the data manually for 100% reliability
            const payload = {
                code: document.getElementById('code').value,
                name: document.getElementById('name').value,
                credits: parseInt(document.getElementById('credits').value),
                ownerLecturerId: document.getElementById('ownerLecturerId').value,
                semesterId: document.getElementById('semesterId').value,
                sections: []
            };

            document.querySelectorAll('.section-item').forEach(secEl => {
                const section = {
                    sectionId: secEl.querySelector('.sec-id').value,
                    lecturerId: secEl.querySelector('.sec-lecturer').value || payload.ownerLecturerId,
                    capacity: parseInt(secEl.querySelector('.sec-cap').value),
                    schedule: []
                };

                secEl.querySelectorAll('.schedule-item').forEach(schEl => {
                    section.schedule.push({
                        dayOfWeek: parseInt(schEl.querySelector('.sch-day').value),
                        startTime: schEl.querySelector('.sch-start').value,
                        endTime: schEl.querySelector('.sch-end').value,
                        roomId: schEl.querySelector('.sch-room').value
                    });
                });

                payload.sections.push(section);
            });

            try {
                const res = await fetch('/admin/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.success) {
                    alert('Course Created!');
                    window.location.href = '/admin/courses';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Server connection failed');
            }
        });
    </script>
</body>

</html>