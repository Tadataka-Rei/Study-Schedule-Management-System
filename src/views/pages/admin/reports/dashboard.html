<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - SSMS</title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Reports</h1>
            <div class="user-info">
                <span>Welcome, <span id="userName"></span></span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </header>
        
        <nav class="dashboard-nav">
            <ul>
                <li><a href="/admin/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="/admin/users" class="nav-link">User Management</a></li>
                <li><a href="/admin/courses" class="nav-link">Course Management</a></li>
                <li><a href="/admin/semesters" class="nav-link">Semester Management</a></li>
                <li><a href="/admin/reports" class="nav-link active">Reports</a></li>
            </ul>
        </nav>
        
        <main class="dashboard-content">
            <section class="reports-overview">
                <h2>Generate Reports</h2>
                <div class="report-cards">
                    <div class="report-card" onclick="generateReport('enrollment')">
                        <h3>Enrollment Report</h3>
                        <p>View student enrollment statistics, course enrollment trends, and registration data.</p>
                        <button class="btn-report">Generate Report</button>
                    </div>
                    
                    <div class="report-card" onclick="generateReport('course')">
                        <h3>Course Report</h3>
                        <p>Analyze course capacity, enrollment rates, and lecturer workload.</p>
                        <button class="btn-report">Generate Report</button>
                    </div>
                    
                    <div class="report-card" onclick="generateReport('user')">
                        <h3>User Report</h3>
                        <p>View user statistics by role, active users, and system usage patterns.</p>
                        <button class="btn-report">Generate Report</button>
                    </div>
                    
                    <div class="report-card" onclick="generateReport('timetable')">
                        <h3>Timetable Report</h3>
                        <p>Analyze class schedules, room utilization, and event distribution.</p>
                        <button class="btn-report">Generate Report</button>
                    </div>
                </div>
            </section>
            
            <section id="reportResults" class="report-results" style="display: none;">
                <div class="report-header">
                    <h2 id="reportTitle">Report Results</h2>
                    <div class="report-actions">
                        <select id="semesterFilter" onchange="refreshReport()">
                            <option value="">All Semesters</option>
                        </select>
                        <button onclick="exportReport()" class="btn-export">Export to CSV</button>
                        <button onclick="closeReport()" class="btn-close">Close</button>
                    </div>
                </div>
                
                <div id="reportContent" class="report-content">
                    <!-- Report content will be loaded here -->
                </div>
            </section>
        </main>
    </div>
    
    <script src="/js/dashboard.js"></script>
    <script>
        let currentReportType = null;
        let currentReportData = null;
        let semesters = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadSemesters();
        });
        
        async function loadSemesters() {
            try {
                const response = await fetch('/admin/reports/semesters');
                const data = await response.json();
                
                if (data.success) {
                    semesters = data.semesters;
                    populateSemesterFilter();
                }
            } catch (error) {
                console.error('Error loading semesters:', error);
            }
        }
        
        function populateSemesterFilter() {
            const select = document.getElementById('semesterFilter');
            semesters.forEach(semester => {
                const option = document.createElement('option');
                option.value = semester._id;
                option.textContent = semester.name;
                select.appendChild(option);
            });
        }
        
        async function generateReport(type) {
            currentReportType = type;
            const semesterId = document.getElementById('semesterFilter').value;
            
            try {
                let url = `/admin/reports/${type}`;
                if (semesterId) {
                    url += `?semesterId=${semesterId}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    currentReportData = data.report;
                    displayReport(data.report);
                } else {
                    alert('Failed to generate report: ' + data.error);
                }
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report');
            }
        }
        
        function displayReport(report) {
            const resultsSection = document.getElementById('reportResults');
            const reportTitle = document.getElementById('reportTitle');
            const reportContent = document.getElementById('reportContent');
            
            // Set title
            const titles = {
                'enrollment': 'Enrollment Report',
                'course': 'Course Report',
                'user': 'User Report',
                'timetable': 'Timetable Report'
            };
            reportTitle.textContent = titles[report.type] || 'Report';
            
            // Generate report content based on type
            let content = '';
            
            switch (report.type) {
                case 'enrollment':
                    content = generateEnrollmentReportHTML(report);
                    break;
                case 'course':
                    content = generateCourseReportHTML(report);
                    break;
                case 'user':
                    content = generateUserReportHTML(report);
                    break;
                case 'timetable':
                    content = generateTimetableReportHTML(report);
                    break;
                default:
                    content = '<p>Report data not available</p>';
            }
            
            reportContent.innerHTML = content;
            resultsSection.style.display = 'block';
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateEnrollmentReportHTML(report) {
            let html = `
                <div class="report-summary">
                    <h3>Enrollment Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Actions:</span>
                            <span class="stat-value">${report.stats.reduce((sum, stat) => sum + stat.count, 0)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Enrollment by Action</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Action</th><th>Count</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.stats.forEach(stat => {
                html += `<tr><td>${stat._id}</td><td>${stat.count}</td></tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="report-section">
                    <h3>Top Courses by Enrollment</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Course</th><th>Enrollments</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.courseEnrollments.slice(0, 10).forEach(enrollment => {
                html += `<tr><td>${enrollment.course.code} - ${enrollment.course.name}</td><td>${enrollment.totalEnrollments}</td></tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }
        
        function generateCourseReportHTML(report) {
            return `
                <div class="report-summary">
                    <h3>Course Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Courses:</span>
                            <span class="stat-value">${report.summary.totalCourses}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Capacity:</span>
                            <span class="stat-value">${report.summary.totalCapacity}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Enrolled:</span>
                            <span class="stat-value">${report.summary.totalEnrolled}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Average Enrollment:</span>
                            <span class="stat-value">${report.summary.averageEnrollment}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>All Courses</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Code</th><th>Name</th><th>Credits</th><th>Lecturer</th><th>Semester</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.courses.forEach(course => {
                html += `
                    <tr>
                        <td>${course.code}</td>
                        <td>${course.name}</td>
                        <td>${course.credits}</td>
                        <td>${course.ownerLecturerId ? course.ownerLecturerId.profile.fullName : 'N/A'}</td>
                        <td>${course.semesterId ? course.semesterId.name : 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateUserReportHTML(report) {
            return `
                <div class="report-summary">
                    <h3>User Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Users:</span>
                            <span class="stat-value">${report.summary.totalUsers}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Users:</span>
                            <span class="stat-value">${report.summary.activeUsers}</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Users by Role</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Role</th><th>Count</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.summary.roleStats.forEach(stat => {
                html += `<tr><td>${stat._id}</td><td>${stat.count}</td></tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="report-section">
                    <h3>All Users</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Name</th><th>Email</th><th>Role</th><th>ID</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.profile.fullName}</td>
                        <td>${user.profile.email}</td>
                        <td>${user.role}</td>
                        <td>${user.profile.studentId || user.profile.lecturerId || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateTimetableReportHTML(report) {
            return `
                <div class="report-summary">
                    <h3>Timetable Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Events:</span>
                            <span class="stat-value">${report.summary.totalEvents}</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Events by Type</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Type</th><th>Count</th></tr>
                        </thead>
                        <tbody>
            `;
            
            report.summary.eventsByType.forEach(stat => {
                html += `<tr><td>${stat._id}</td><td>${stat.count}</td></tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function refreshReport() {
            if (currentReportType) {
                generateReport(currentReportType);
            }
        }
        
        function exportReport() {
            if (!currentReportData) return;
            
            // Simple CSV export (you can enhance this)
            let csv = 'Report Data\n';
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Add summary data
            if (currentReportData.summary) {
                Object.entries(currentReportData.summary).forEach(([key, value]) => {
                    csv += `${key},${value}\n`;
                });
            }
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentReportType}_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function closeReport() {
            document.getElementById('reportResults').style.display = 'none';
            currentReportType = null;
            currentReportData = null;
        }
    </script>
    
    <style>
        .report-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .report-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .report-card h3 {
            color: #007bff;
            margin-bottom: 1rem;
        }
        
        .report-card p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .btn-report {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .report-results {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .report-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .report-actions select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn-export, .btn-close {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-export {
            background: #28a745;
            color: white;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
        }
        
        .report-summary {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 2rem;
        }
        
        .summary-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .report-section {
            margin-bottom: 2rem;
        }
        
        .report-section h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .data-table tr:hover {
            background: #f5f5f5;
        }
    </style>
</body>
</html>
